<!DOCTYPE html>
<!-- 
  Personal Discovery Chat Hub
  Created with love for my wife
  
  This is a simple, elegant chat interface that connects to an n8n webhook.
  It provides a labyrinth of discovery through conversation, allowing my wife
  to explore topics she's curious about in a beautiful, intuitive interface.
  
  The chat uses a custom implementation with fallback capabilities to ensure
  it works across different browsers and environments.
-->

<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Personal Discovery Assistant</title>
    <meta name="description" content="A personal discovery tool just for you" />
    <link rel="icon" href="/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #9f7aea;
        --primary-dark: #805ad5;
        --secondary: #f687b3;
        --background: #faf5ff;
        --text: #44337a;
        --light-text: #6b46c1;
        --white: #ffffff;
        --shadow: rgba(159, 122, 234, 0.2);
      }
      
      body {
        font-family: 'Nunito', sans-serif;
        background: linear-gradient(135deg, #2c3e50, #bdc3c7);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }
      
      .container {
        width: 100%;
        max-width: 1200px;
        padding: 2rem;
        margin: 0 auto;
        text-align: center;
      }
      
      h1 {
        font-size: 3rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 1rem;
        line-height: 1.2;
      }
      
      .subtitle {
        font-size: 1.5rem;
        color: var(--light-text);
        max-width: 600px;
        margin: 0 auto;
      }
      
      .personal-message {
        font-size: 1.2rem;
        font-style: italic;
        margin: 1.5rem 0;
        color: var(--secondary);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }
      
      .footer {
        margin-top: 2.5rem;
        text-align: center;
        font-size: 0.9rem;
        color: var(--light-text);
      }
      
      #n8n-chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        height: 500px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 25px var(--shadow);
        background-color: var(--white);
      }
      
      @media (max-width: 768px) {
        h1 {
          font-size: 2.2rem;
        }
        
        .subtitle {
          font-size: 1.2rem;
        }
        
        #n8n-chat-container {
          width: 90%;
          right: 5%;
          left: 5%;
          height: 70vh;
        }
      }
      
      @media (max-width: 480px) {
        h1 {
          font-size: 1.8rem;
        }
        
        .subtitle {
          font-size: 1rem;
        }
        
        .personal-message {
          font-size: 1rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Your Discovery Assistant</h1>
      <p class="subtitle">Ask me anything you're curious about - I'm here to help you explore and learn.</p>
      <p class="personal-message">Made with love, just for you.</p>
      
      <div class="footer">
        <p>Powered by your love and care ❤️</p>
      </div>
    </div>
    
    <!-- Container where the chat widget will be rendered -->
    <div id="n8n-chat-container"></div>

    <!-- Import the n8n chat widget script -->
    <script type="module">
      // Try to load the chat widget using the ES module
      // First we attempt to load the official n8n chat widget
      // If that fails due to CORS or MIME issues, we fall back to our custom implementation
      try {
        const module = await import('https://unpkg.com/n8n-chat@0.27.1/dist/index.js');
        const { createChat } = module;
        
        // Initialize the chat widget
        createChat({
          container: document.getElementById('n8n-chat-container'),
          webhookUrl: 'https://primary-production-5417.up.railway.app/webhook/a889d2ae-2159-402f-b326-5f61e90f602e/chat',
          theme: {
            primaryColor: '#9f7aea',
            textColor: '#44337a',
            fontFamily: 'Nunito, sans-serif',
          },
          initialMessages: ['Welcome to our labyrinth of discovery! Ask anything.'],
        });
        
        console.log('Chat widget initialized successfully');
      } catch (error) {
        console.error('Failed to load chat widget:', error);
        
        // FALLBACK IMPLEMENTATION
        // This custom chat interface activates when the official widget can't be loaded
        // It provides the same core functionality with a similar look and feel
        // Fallback to custom implementation if module loading fails
        const chatContainer = document.getElementById('n8n-chat-container');
        
        // Create fallback UI
        chatContainer.innerHTML = `
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="background-color: #9f7aea; color: white; padding: 10px; text-align: center;">
              <h3 style="margin: 0;">Discovery Chat</h3>
            </div>
            <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px;"></div>
            <div style="border-top: 1px solid #eee; padding: 10px; display: flex;">
              <input id="chat-input" type="text" placeholder="Type your question..." 
                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <button id="chat-send" style="margin-left: 10px; background: #9f7aea; color: white; border: none; 
                      padding: 8px 15px; border-radius: 4px; cursor: pointer;">Send</button>
            </div>
          </div>
        `;
        
        const messagesDiv = document.getElementById('chat-messages');
        const inputEl = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send');
        
        // Add welcome message
        messagesDiv.innerHTML = `
          <div style="background: #f0f0f0; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%;">
            Hi love, Ask anything here and a neat answer will be given. (this chat is not conversational, it only responds to one message at a time)
          </div>
        `;
        
        // This function handles sending user messages to the n8n webhook
        // and displaying the response in the chat interface
        // Handle sending messages
        function sendMessage() {
          const message = inputEl.value.trim();
          if (!message) return;
          
          // Add user message
          messagesDiv.innerHTML += `
            <div style="background: #9f7aea; color: white; padding: 10px; border-radius: 10px; 
                        margin-bottom: 10px; max-width: 80%; margin-left: auto;">
              ${message}
            </div>
          `;
          
          // Clear input
          inputEl.value = '';
          
          // Show a "thinking" indicator while waiting for the response
          // Add loading indicator
          const loadingId = 'loading-' + Date.now();
          messagesDiv.innerHTML += `
            <div id="${loadingId}" style="background: #f0f0f0; padding: 10px; border-radius: 10px; 
                                      margin-bottom: 10px; max-width: 80%;">
              Thinking (of you)...
            </div>
          `;
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          
          // Send the message to the n8n webhook endpoint
          // Send to webhook
          fetch('https://primary-production-5417.up.railway.app/webhook/a889d2ae-2159-402f-b326-5f61e90f602e/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'sendMessage', chatInput: message })
          })
          .then(response => response.json())
          .then(data => {
            // Remove loading indicator
            document.getElementById(loadingId).remove();
            
            // Handle various response formats from different n8n workflows
            // This ensures compatibility with different webhook configurations
            // Add response message
            console.log('Response data:', data);
            let responseText = "I'm having trouble formatting my response right now, sorry hoss.";
            
            // Handle different response formats
            if (data && typeof data === 'object') {
              if (data.response) responseText = data.response;
              else if (data.text) responseText = data.text;
              else if (data.message) responseText = data.message;
              else if (data.content) responseText = data.content;
              else if (data.answer) responseText = data.answer;
              else if (data.result && data.result.text) responseText = data.result.text;
              else if (data.data && data.data.text) responseText = data.data.text;
              else if (data.output) responseText = data.output;
            } else if (typeof data === 'string') {
              responseText = data;
            }
            
            messagesDiv.innerHTML += `
              <div style="background: #f0f0f0; padding: 10px; border-radius: 10px; 
                          margin-bottom: 10px; max-width: 80%;">
                ${responseText}
              </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          })
          .catch(error => {
            // Error handling for failed requests
            // Remove loading indicator
            document.getElementById(loadingId).remove();
            
            // Add error message
            messagesDiv.innerHTML += `
              <div style="background: #f0f0f0; padding: 10px; border-radius: 10px; 
                          margin-bottom: 10px; max-width: 80%;">
                I'm having trouble connecting right now. Please try again in a moment.
              </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          });
        }
        
        // Set up event listeners for the chat interface
        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        inputEl.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    </script>
  </body>
</html>
